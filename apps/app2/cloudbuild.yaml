steps:
  # Step 1: Git history 가져오기
  - name: 'gcr.io/cloud-builders/git'
    id: 'fetch-git-history'
    entrypoint: 'bash'
    secretEnv: ['GITHUB_TOKEN']
    args:
      - '-c'
      - |
        git config --global url."https://x-access-token:$$GITHUB_TOKEN@github.com/".insteadOf "https://github.com/"
        git fetch --unshallow || true
        git fetch origin main:main

  # Step 2: Node.js 의존성 설치
  - name: 'node:20'
    id: 'install-dependencies'
    entrypoint: 'npm'
    args: ['ci']

  # Step 3: 마지막 배포 커밋 해시 조회
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'get-last-deployed-sha'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        LAST_DEPLOYED_SHA=$$(gcloud artifacts docker images list \
          asia-northeast3-docker.pkg.dev/newwwbi-playground/nx-apps/app2 \
          --include-tags \
          --format='get(tags)' \
          --sort-by=~CREATE_TIME \
          --limit=1 2>/dev/null | tr ',' '\n' | tr -d ' ' | grep -v '^latest$$' | head -1 || echo "")

        if [ -z "$$LAST_DEPLOYED_SHA" ]; then
          echo "No previous deployment found."
          echo "" > /workspace/last_deployed_sha
        else
          echo "Last deployed commit: $$LAST_DEPLOYED_SHA"
          echo "$$LAST_DEPLOYED_SHA" > /workspace/last_deployed_sha
        fi

  # Step 4: nx affected 확인
  - name: 'node:20'
    id: 'check-affected'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        LAST_DEPLOYED_SHA=$$(cat /workspace/last_deployed_sha)

        if [ -z "$$LAST_DEPLOYED_SHA" ]; then
          echo "No previous deployment. Building app2..."
          echo "true" > /workspace/should_build
        else
          echo "Checking affected projects between $$LAST_DEPLOYED_SHA and $SHORT_SHA"

          AFFECTED=$$(npx nx show projects --affected --base=$$LAST_DEPLOYED_SHA --head=$SHORT_SHA 2>/dev/null || echo "")

          if echo "$$AFFECTED" | grep -q "app2"; then
            echo "app2 is affected. Building..."
            echo "true" > /workspace/should_build
          else
            echo "app2 is not affected. Skipping build."
            echo "false" > /workspace/should_build
          fi
        fi

  # Step 5: 변경 없으면 빌드 취소
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'cancel-if-not-affected'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$$(cat /workspace/should_build)" != "true" ]; then
          echo "No affected projects. Cancelling build."
          gcloud builds cancel $BUILD_ID
        fi

  # Step 6: Docker 빌드
  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-build'
    args:
      - 'build'
      - '-f'
      - 'apps/app2/Dockerfile'
      - '-t'
      - 'asia-northeast3-docker.pkg.dev/newwwbi-playground/nx-apps/app2:$SHORT_SHA'
      - '.'

  # Step 7: Artifact Registry로 푸시
  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-push'
    args:
      - 'push'
      - 'asia-northeast3-docker.pkg.dev/newwwbi-playground/nx-apps/app2:$SHORT_SHA'

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/github-token/versions/latest
      env: 'GITHUB_TOKEN'

options:
  logging: CLOUD_LOGGING_ONLY
